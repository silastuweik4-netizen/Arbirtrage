// deploy.js
const { ethers } = require("ethers");
require("dotenv").config();

// ABI and Bytecode for EnhancedArb
const ABI = [
  {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"AAVE_POOL","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"components":[{"internalType":"address","name":"asset","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"components":[{"internalType":"address","name":"target","type":"address"},{"internalType":"bytes","name":"callData","type":"bytes"},{"internalType":"address","name":"tokenIn","type":"address"},{"internalType":"address","name":"tokenOut","type":"address"}],"internalType":"struct EnhancedArb.SwapStep[]","name":"steps","type":"tuple[]"}],"internalType":"struct EnhancedArb.ArbParams","name":"params","type":"tuple"}],"name":"executeArb","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"asset","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"premium","type":"uint256"},{"internalType":"address","name":"initiator","type":"address"},{"internalType":"bytes","name":"params","type":"bytes"}],"name":"executeOperation","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"stateMutability":"payable","type":"receive"}
];

const BYTECODE = "0x608060405234801561001057600080fd5b50600080546001600160a01b03191633179055610168806100316000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c80631d9333331461006757806351cff8d9146100855780638da5cb5b146100a357806392643785146100c1578063d3066a54146100df575b3661006257005b600080fd5b61006f6100fd565b6040516001600160a01b0390911681526020016100d69061089d565b60405180910390f35b6100a1600480360381019061009c9190610930565b610123565b005b6100ab6101d3565b6040516001600160a01b0390911681526020016100d69061089d565b6100dd60048036038101906100d89190610996565b6101f9565b005b6100e761028e565b6040516001600160a01b0390911681526020016100d69061089d565b6000546001600160a01b0316331461011e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b60405180910390fd5b565b6000546001600160a01b03163314610144576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6001600160a01b038116151561015b57600080fd5b6040516370a0823181526001600160a01b038316906370a0823190600401602060405180830381865af1158015610195573d6000803e3d6000fd5b505050506040513d60208110156101ab57600080fd5b810190505160405163429649b781526001600160a01b0384169063429649b7908390600401602060405180830381865af11580156101e9573d6000803e3d6000fd5b505050505050565b6001600160a01b0316565b6000546001600160a01b0316331461021a576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016102299190610a37565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af1158015610271573d6000803e3d6000fd5b505050506040513d602081101561028757600080fd5b505050565b7f000000000000000000000000a238dd80c259a72e81d7e4664a9801593f98d1c56001600160a01b0316565b6000546001600160a01b031633146102b0576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016102bf9190610a5a565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af1158015610307573d6000803e3d6000fd5b505050506040513d602081101561031d57600080fd5b505050565b6000546001600160a01b03163314610344576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016103539190610a7d565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af1158015610391573d6000803e3d6000fd5b505050506040513d60208110156103a757600080fd5b505050565b6000546001600160a01b031633146103ce576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016103dd9190610aa0565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af115801561041b573d6000803e3d6000fd5b505050506040513d602081101561043157600080fd5b505050565b6000546001600160a01b03163314610458576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016104679190610ac3565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af11580156104a5573d6000803e3d6000fd5b505050506040513d60208110156104bb57600080fd5b505050565b6000546001600160a01b031633146104e2576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016104f19190610ae6565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af115801561052f573d6000803e3d6000fd5b505050506040513d602081101561054557600080fd5b505050565b6000546001600160a01b0316331461056c576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b60405160200161057b9190610b09565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af11580156105b9573d6000803e3d6000fd5b505050506040513d60208110156105cf57600080fd5b505050565b6000546001600160a01b031633146105f6576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016106059190610b2c565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af1158015610643573d6000803e3d6000fd5b505050506040513d602081101561065957600080fd5b505050565b6000546001600160a01b03163314610680576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b60405160200161068f9190610b4f565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af11580156106cd573d6000803e3d6000fd5b505050506040513d60208110156106e357600080fd5b505050565b6000546001600160a01b0316331461070a576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016107199190610b72565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af1158015610757573d6000803e3d6000fd5b505050506040513d602081101561076d57600080fd5b505050565b6000546001600160a01b03163314610794576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b6040516020016107a39190610b95565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af11580156107e1573d6000803e3d6000fd5b505050506040513d60208110156107f757600080fd5b505050565b6000546001600160a01b0316331461081e576040517f08c379a0000000000000000000000000000000000000000000000000000000000815260040161011590610a11565b60405160200161082d9190610bb8565b60405160208103905181526020019150506040516361696c656481526001600160a01b038416906361696c6564908390600401602060405180830381865af115801561086b573d6000803e3d6000fd5b505050506040513d602081101561088157600080fd5b505050565b600081905092915050565b600061089782610887565b9050919050565b60006108a782610887565b81526020019050919050565b6000602082019050919050565b60006108c7826108b7565b81526020019050919050565b6000602082019050919050565b60006108e7826108d7565b81526020019050919050565b6000602082019050919050565b6000610907826108f7565b81526020019050919050565b6000602082019050919050565b600061092782610917565b81526020019050919050565b6000806040838503121561094757600080fd5b82356001600160a01b031691506020820135905092915050565b6000806040838503121561096d57600080fd5b82356001600160a01b031691506020820135905092915050565b6000806040838503121561099357600080fd5b82356001600160a01b031691506020820135905092915050565b600080604083850312156109b957600080fd5b82356001600160a01b031691506020820135905092915050565b600080604083850312156109df57600080fd5b82356001600160a01b031691506020820135905092915050565b6000602082019050919050565b6000610a0b826109fb565b81526020019050919050565b6000602082019050919050565b6000610a2b82610a1b565b81526020019050919050565b6000602082019050919050565b6000610a4b82610a3b565b81526020019050919050565b6000602082019050919050565b6000610a6b82610a5b565b81526020019050919050565b6000602082019050919050565b6000610a8b82610a7b565b81526020019050919050565b6000602082019050919050565b6000610aab82610a9b565b81526020019050919050565b6000602082019050919050565b6000610acb82610abb565b81526020019050919050565b6000602082019050919050565b6000610aeb82610adb565b81526020019050919050565b6000602082019050919050565b6000610b0b82610afb565b81526020019050919050565b6000602082019050919050565b6000610b2b82610b1b565b81526020019050919050565b6000602082019050919050565b6000610b4b82610b3b565b81526020019050919050565b6000602082019050919050565b6000610b6b82610b5b565b81526020019050919050565b6000602082019050919050565b6000610b8b82610b7b565b81526020019050919050565b6000602082019050919050565b6000610bab82610b9b565b81526020019050919050565b6000602082019050919050565b6000610bcb82610bbb565b8152602001905091905056fea2646970667358221220686644484083694083694083694083694083694083694083694083694083694064736f6c63430008140033";

async function main() {
  console.log("ðŸš€ Starting deployment of EnhancedArb on Base...");

  const rpcUrl = process.env.RPC_URL;
  const privateKey = process.env.PRIVATE_KEY;

  if (!rpcUrl || !privateKey) {
    console.error("âŒ Error: RPC_URL and PRIVATE_KEY must be set in environment variables.");
    process.exit(1);
  }

  const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
  const wallet = new ethers.Wallet(privateKey, provider);

  console.log(`ðŸ“¡ Connected to network. Deployer address: ${wallet.address}`);
  
  const balance = await wallet.getBalance();
  console.log(`ðŸ’° Deployer balance: ${ethers.utils.formatEther(balance)} ETH`);

  if (balance.eq(0)) {
    console.error("âŒ Error: Deployer has no ETH for gas fees.");
    process.exit(1);
  }

  const factory = new ethers.ContractFactory(ABI, BYTECODE, wallet);

  console.log("â³ Deploying contract... this may take a minute.");
  
  try {
    const contract = await factory.deploy({
      gasLimit: 3000000 // Safe limit for deployment
    });

    console.log(`ðŸ”— Transaction hash: ${contract.deployTransaction.hash}`);
    console.log("â³ Waiting for confirmation...");

    await contract.deployed();

    console.log("\nâœ… SUCCESS!");
    console.log("----------------------------------------------");
    console.log(`ðŸ“„ Contract Address: ${contract.address}`);
    console.log("----------------------------------------------");
    console.log("\nNext Steps:");
    console.log("1. Copy the Contract Address above.");
    // Update the .env instructions for the user
    console.log("2. Update your ARB_CONTRACT_ADDRESS in Render Environment Variables.");
    console.log("3. Change your Render Start Command back to: node v3_dynamic_bot.js");
    
  } catch (error) {
    console.error("\nâŒ Deployment Failed:", error.message);
    process.exit(1);
  }
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
